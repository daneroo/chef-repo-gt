# nginx <%= @vhost %> vhost for <%= @host_name ? @host_name : "_default_" %>
#
# Generated by Chef for <%= node[:fqdn] %>
# Local modifications will be overwritten.
#
<% if @non_ssl_server && @www_redirect -%>
server {
<% @listen_ports.each do |port| -%>
  listen              <%= port %>;
<% end -%>
<% if @host_name.nil? -%>
  server_name         www.*;
<% else -%>
  server_name         www.<%= @host_name %>;
<% end -%>

  rewrite ^/(.*)      http://<%= @host_name %>/$1 permanent;
}

<% end -%>
<% if @non_ssl_server -%>
server {
<% @listen_ports.each do |port| -%>
  listen              <%= port %>;
<% end -%>
<% if @host_name.nil? -%>
  server_name         "";
<% else -%>
  server_name         <%= @host_name %><% @host_aliases.each do |a| %><%= " #{a}" %> <% end %>;
<% end -%>

  error_log           <%= node[:nginx][:log_dir] %>/<%= @app %>-error.log;
  access_log          <%= node[:nginx][:log_dir] %>/<%= @app %>-access.log;

  include             <%= @partials_path %>/*.conf;
}
<% end -%>
<% if @ssl_server && @ssl_www_redirect -%>

server {
<% @ssl_listen_ports.each do |port| -%>
  listen              <%= port %>;
<% end -%>
<% if @host_name.nil? -%>
  server_name         www.*;
<% else -%>
  server_name         www.<%= @host_name %>;
<% end -%>

  ssl                 on;
  ssl_certificate     <%= @ssl_cert %>;
  ssl_certificate_key <%= @ssl_key %>;
 
  rewrite ^/(.*)      https://<%= @host_name %>/$1 permanent;
}
<% end -%>
<% if @ssl_server -%>

server {
<% @ssl_listen_ports.each do |port| -%>
  listen              <%= port %>;
<% end -%>
<% if @host_name.nil? -%>
  server_name         "";
<% else -%>
  server_name         <%= @host_name %><% @host_aliases.each do |a| %><%= " #{a}" %> <% end %>;
<% end -%>

  ssl                 on;
  ssl_certificate     <%= @ssl_cert %>;
  ssl_certificate_key <%= @ssl_key %>;
 
  error_log           <%= node[:nginx][:log_dir] %>/<%= @app %>-error.log;
  access_log          <%= node[:nginx][:log_dir] %>/<%= @app %>-access.log;

  include             <%= @partials_path %>/*.conf;
}
<% end -%>
