# apache2 <%= @vhost %> vhost for <%= @host_name ? @host_name : "_default_" %>
#
# Generated by Chef for <%= node[:fqdn] %>
# Local modifications will be overwritten.
#
<% if @non_ssl_server && @www_redirect && !@host_name.nil? -%>
<VirtualHost *:80>
  ServerName        www.<%= @host_name %>
<% @host_aliases.each do |a| -%>
  ServerAlias       www.<%= a %>
<% end -%>

  RewriteEngine     On
  RewriteCond       %{HTTP_HOST} ^www.<%= @host_name %>$ [NC]
  RewriteRule       ^/(.*)$ http://<%= @host_name %>/$1 [R=301,L]
</VirtualHost>

<% end -%>
<% if @non_ssl_server -%>
<VirtualHost *:80>
<% unless @host_name.nil? -%>
  ServerName        <%= @host_name %>
<% end -%>
<% @host_aliases.each do |a| -%>
  ServerAlias       <%= a %>
<% end -%>

  ErrorLog          <%= node[:apache][:log_dir] %>/<%= @vhost %>-error_log
  CustomLog         <%= node[:apache][:log_dir] %>/<%= @vhost %>-access_log combined

  Include           <%= @partials_path %>/*.conf
</VirtualHost>
<% end -%>
<% if @ssl_server -%>

<IfDefine SSL>
<IfDefine !NOSSL>
<% end -%>
<% if @ssl_www_redirect && !@host_name.nil? -%>

<VirtualHost *:443>
  ServerName        www.<%= @host_name %>
<% @host_aliases.each do |a| -%>
  ServerAlias       www.<%= a %>
<% end -%>

  RewriteEngine     On
  RewriteCond       %{HTTP_HOST} ^www.<%= @host_name %>$ [NC]
  RewriteRule       ^/(.*)$ http://<%= @host_name %>/$1 [R=301,L]
</VirtualHost>
<% end -%>
<% if @ssl_server %>

<VirtualHost *:443>
<% unless @host_name.nil? -%>
  ServerName        <%= @host_name %>
<% end -%>
<% @host_aliases.each do |a| -%>
  ServerAlias       <%= a %>
<% end -%>

  SSLEngine         On
  SSLCipherSuite    ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP:+eNULL

  SSLCertificateFile    <%= @ssl_cert %>
  SSLCertificateKeyFile <%= @ssl_key %>

  SetEnvIf          User-Agent ".*MSIE.*" \
                    nokeepalive ssl-unclean-shutdown \
                    downgrade-1.0 force-response-1.0

  ErrorLog          <%= node[:apache][:log_dir] %>/<%= @vhost %>-error_log
  CustomLog         <%= node[:apache][:log_dir] %>/<%= @vhost %>-access_log combined

  Include           <%= @partials_path %>/*.conf
</VirtualHost>

</IfDefine>
</IfDefine>
<% end -%>
